
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Aptalca's Musings">
      
      
      
        <link rel="canonical" href="https://aptalca.github.io/musings/Other/zfs_send_receive/">
      
      
        <link rel="prev" href="../tape_backup/">
      
      
        <link rel="next" href="../zfshost/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>ZFS Send/Receive - Aptalca's Musings</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#zfs-sendreceive" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://aptalca.github.io/musings" title="Aptalca&#39;s Musings" class="md-header__button md-logo" aria-label="Aptalca's Musings" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Aptalca's Musings
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ZFS Send/Receive
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/aptalca/musings" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../cellular_backup/" class="md-tabs__link">
          
  
  
  Other

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://aptalca.github.io/musings" title="Aptalca&#39;s Musings" class="md-nav__button md-logo" aria-label="Aptalca's Musings" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Aptalca's Musings
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aptalca/musings" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Other
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Other
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cellular_backup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cellular Backup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tape_backup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tape Backup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    ZFS Send/Receive
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    ZFS Send/Receive
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general-facts-for-consideration" class="md-nav__link">
    <span class="md-ellipsis">
      General Facts For Consideration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plan" class="md-nav__link">
    <span class="md-ellipsis">
      Plan
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specific-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Specific Steps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Specific Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Initial sync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subsequent-incremental-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Subsequent Incremental Sync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clean-up-after-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Clean Up After Sync
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#my-ugly-script" class="md-nav__link">
    <span class="md-ellipsis">
      My Ugly Script
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zfshost/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Zfshost
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general-facts-for-consideration" class="md-nav__link">
    <span class="md-ellipsis">
      General Facts For Consideration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plan" class="md-nav__link">
    <span class="md-ellipsis">
      Plan
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specific-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Specific Steps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Specific Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Initial sync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subsequent-incremental-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Subsequent Incremental Sync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clean-up-after-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Clean Up After Sync
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#my-ugly-script" class="md-nav__link">
    <span class="md-ellipsis">
      My Ugly Script
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <nav class="md-tags" >
    
      
      
      
        <a href="../../.#tag:other" class="md-tag">Other</a>
      
    
  </nav>



<h1 id="zfs-sendreceive">ZFS Send/Receive</h1>
<p><code>zfs send</code> from main server and <code>zfs receive</code> on backup server</p>
<h2 id="general-facts-for-consideration">General Facts For Consideration</h2>
<ol>
<li>Both <code>zfs send</code> and <code>zfs receive</code> operations require plenty of permissions, which can be assigned to an unprivileged user via <code>zfs allow</code> (we should not run the script as root on either end as most guides suggest)</li>
<li>If the source dataset is auto-mounted, it will be attempted to be mounted on the receiving end, which can be a problem</li>
<li>If a backup dataset is mounted, there is a possibility (highly likely if <code>atime</code> is on) that it will be modified on the receiving end, semi-breaking future incremental updates</li>
<li>For scripted operations, one would need to have an ssh key without passphrase on either the main or the backup server, for the other one.</li>
<li>Unlike rsync, which compares source and destination data for diff calculation, <code>zfs send</code> only compares 2 snapshots on the source end to calculate diff, meaning the source and destination must contain a common snapshot, which should be used as the base of the diff on the sending end</li>
<li>All properties of the source dataset will be set on the backup dataset as is, which means any property that is <code>inherited</code> on the source will also be set as <code>inherited</code> on the backup, so the actual value may differ (such as the mountpoint)</li>
<li>If the machine with the ssh key gets compromised, the other machine is also compromised due to no ssh key passphrase</li>
<li>If the source machine gets compromised (ransomwared), the changes can propagate to backups</li>
<li>If <code>zfs allow</code> has the <code>destroy</code> permission, a compromised machine can potentially destroy all zfs data including the pools, datasets and the snapshots.</li>
<li>Initial <code>send</code> requires that the destination does not have the existing dataset (you can force but I'd rather keep it clean and simple)</li>
<li>Incremental <code>send</code> requires the destination state matches the base snapshot used in <code>send</code></li>
</ol>
<h2 id="plan">Plan</h2>
<ul>
<li>Due to <code>1.</code> and <code>4.</code> above, we will use a dedicated unprivileged linux user <code>zfsbackup</code> (not in sudoers) on both the sending and the receiving ends<ul>
<li>On the sending end, the user will need the <code>zfs allow</code> perms <code>create,mount,rename,send,snapshot</code> (<code>create</code> and <code>mount</code> are there because they are required by others) (we do not assign the <code>destroy</code> perm due to <code>9.</code>)</li>
<li>On the receiving end, the user will need the <code>zfs allow</code> perms <code>atime,canmount,create,mount,readonly,receive,rename</code> (<code>create</code> and <code>mount</code> are there because they are required by others) (we do not assign the <code>destroy</code> perm due to <code>9.</code>)</li>
<li>Allow perms are per user per dataset and are inherited. Existing perms can be checked via <code>zfs allow &lt;pool&gt;/&lt;dataset&gt;</code></li>
</ul>
</li>
<li>To prevent issues due to <code>2.</code> and <code>3.</code>, we will use the options <code>-o canmount=noauto -u -o readonly=on</code> because the first 2 will prevent mounting on the receiving end and the 3rd will prevent modifications (for good measure).<ul>
<li>We can also add <code>-o atime=off</code> if we do want to mount them, but if it's read only, that should not be necessary.</li>
<li>These options are overridden permanently on the receiving end. If we ever have to recover from these backups, we need to kee in mind that our backup datasets have altered properties, which may need to be reverted after a restore. It is prudent to keep these alterations to a minimum so a potential restore doesn't get too complicated.</li>
</ul>
</li>
<li>Picking the receiving end as the initator and holder of the ssh key with no passphrase because that machine is a dedicated backup machine, has no public facing services and thus less likely to be compromised.</li>
<li>On the receiving end, we create a new encrypted dataset dedicated to holding backups <code>pool/remotebackups</code> and set the options <code>readonly:on</code> and <code>canmount=noauto</code>. Keep in mind that while the <code>readonly</code> setting is inherited, the <code>canmount</code> setting is not.</li>
<li>Because we have multiple pools on the source machine (one for the OS on NVMEs and one for the data/media on HDDs), we'll replicate the same structure on the receiving end to make things simpler:<ul>
<li><code>zarray/Books</code> on the source will be backed up to <code>pool/remotebackups/zarray/Books</code> on the receiving end</li>
<li><code>zroot/ROOT/debian</code> on the source will be backed up to <code>pool/remotebackups/zroot/ROOT/debian</code> on the receiving end</li>
</ul>
</li>
<li>Since we have to specifically define the source snapshot on the sending end during incremental, and that snapshot state has to match the current state of the backup dataset, we will hardcode snapshot names and make assumptions based on that<ul>
<li>We could label the snapshot with date stamps that would match on the sending and the receiving ends, but that would require parsing zfs list outputs and/or keeping a file or db with previous run info. That complicates things and is error prone (hardcoding the snapshot names makes it safer for a cron script to delete them as we reduce the risk of accidentally deleting the wrong snapshot or worse, a dataset)</li>
<li>It's much simpler to rely on the following format for snapshot names:<ul>
<li><code>remotebackup-snapshot</code> for the snapshot that will be sent and received</li>
<li><code>remotebackup-snapshot-1</code> for the snapshot that will be used as the diff base</li>
</ul>
</li>
<li>Prior to send, we rename the snapshots <code>remotebackup-snapshot</code> as <code>remotebackup-snapshot-1</code> on both ends, create a new snapshot <code>remotebackup-snapshot</code> on the sending end, and send that with the diff base <code>remotebackup-snapshot-1</code></li>
<li>At the end of the send operation, both ends will have the matching snapshots <code>remotebackup-snapshot</code> and <code>remotebackup-snapshot-1</code></li>
<li>Nightly, we have to delete the <code>remotebackup-snapshot-1</code> snapshots on both ends but that has to be done by a privileged user like root cron, otherwise the rename will fail due to existing snapshot with that name</li>
<li>At the start of each send operation, we will have only the <code>remotebackup-snapshot</code> on both ends</li>
<li>If the structure and naming of the snapshots gets messed up due to errors when running the script, we'll have the script notify us so we can take manual action</li>
</ul>
</li>
</ul>
<h2 id="specific-steps">Specific Steps</h2>
<h3 id="initial-sync">Initial sync</h3>
<ol>
<li>Let's assume we're syncing <code>zarray/Books</code> on main machine to <code>pool/remotebackups/zarray/Books</code> on the backup machine</li>
<li>Add permissions to source dataset on main machine: <code>sudo zfs allow zfsbackup create,mount,rename,send,snapshot zarray/Books</code></li>
<li>Create the parent pool/dataset on the backup machine: <code>sudo zfs create -o canmount=noauto -o readonly=on pool/remotebackups/zarray</code></li>
<li>Add permissions to backup parent pool/dataset on backup machine: <code>sudo zfs allow zfsbackup atime,canmount,create,mount,readonly,receive,rename pool/remotebackups/zarray</code></li>
<li>Log into <code>zfsbackup</code> on the backup machine: <code>su zfsbackup</code></li>
<li>Create snapshot on the source dataset via ssh: <code>ssh zfsbackup@MAINSERVERIP zfs snapshot zarray/Books@remotebackup-snapshot</code></li>
<li>Perform initial sync via ssh: <code>ssh zfsbackup@MAINSERVERIP zfs send -v zarray/Books@remotebackup-snapshot | zfs receive -o canmount=noauto -u -o readonly=true pool/remotebackups/zarray/Books</code></li>
</ol>
<h3 id="subsequent-incremental-sync">Subsequent Incremental Sync</h3>
<ol>
<li>Log into <code>zfsbackup</code> on the backup machine: <code>su zfsbackup</code></li>
<li>Rotate snapshot on the source dataset via ssh: <code>ssh zfsbackup@MAINSERVERIP zfs rename zarray/Books@remotebackup-snapshot zarray/Books@remotebackup-snapshot-1</code></li>
<li>Create new snapshot on the source dataset via ssh: <code>ssh zfsbackup@MAINSERVERIP zfs snapshot zarray/Books@remotebackup-snapshot</code></li>
<li>Rotate snapshot on the backup dataset: <code>zfs rename pool/remotebackups/zarray/Books@remotebackup-snapshot pool/remotebackups/zarray/Books@remotebackup-snapshot-1</code></li>
<li>Perform incremental sync via ssh: <code>ssh zfsbackup@MAINSERVERIP zfs send -vi zarray/Books@remotebackup-snapshot-1 zarray/Books@remotebackup-snapshot | zfs receive -o canmount=noauto -u -o readonly=true pool/remotebackups/zarray/Books</code></li>
</ol>
<h3 id="clean-up-after-sync">Clean Up After Sync</h3>
<ol>
<li>On the main machine edit the root crontab via <code>sudo crontab -e</code> and add an entry to delete the rotated snapshot: <code>17 0 * * * zfs destroy zarray/Books@remotebackup-snapshot-1</code></li>
<li>On the backup machine edit the root crontab via <code>sudo crontab -e</code> and add an entry to delete the rotated snapshot: <code>17 0 * * * zfs destroy pool/remotebackups/zarray/Books@remotebackup-snapshot-1</code></li>
</ol>
<h2 id="my-ugly-script">My Ugly Script</h2>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># Edit the below values</span>

<span class="c1"># Set Source Datasets</span>
<span class="nv">SOURCEDATASETS</span><span class="o">=</span><span class="s1">&#39;zarray/Books zarray/Misc zroot/home zroot/ROOT/debian&#39;</span>
<span class="c1"># Set Local Backup Base</span>
<span class="nv">BACKUPBASE</span><span class="o">=</span><span class="s1">&#39;pool/remotebackups&#39;</span>
<span class="c1"># Set remote server</span>
<span class="nv">REMOTESERVER</span><span class="o">=</span><span class="s1">&#39;zfsbackup@&lt;SERVERIP&gt;&#39;</span>

<span class="c1"># notify via self hosted server or if that fails, via the public instance</span>
fn_notify<span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>curl<span class="w"> </span>-Lfs<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Title: </span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer &lt;my token&gt;&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span><span class="w">  </span>https://ntfy.&lt;mydomain&gt;/zfshost<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>curl<span class="w"> </span>-Ls<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Title: </span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span><span class="w"> </span>https://ntfy.sh/&lt;my<span class="w"> </span>custom<span class="w"> </span>topic&gt;
<span class="o">}</span>

<span class="c1"># Do not make edits below this line</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;**** Starting sync on </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<span class="c1"># Check to make sure remote server is up and connectable</span>
<span class="k">if</span><span class="w"> </span>ssh<span class="w"> </span>-o<span class="w"> </span><span class="nv">ConnectTimeout</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REMOTESERVER</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Success] Remote server is up and connectable&quot;</span>
<span class="k">else</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] Remote server does not seem to be reachable. Aborting zfs sync.&quot;</span>
<span class="w">  </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failed&quot;</span><span class="w"> </span><span class="s2">&quot;Remote server does not seem to be reachable. Aborting zfs sync.&quot;</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="k">for</span><span class="w"> </span>SRC<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">SOURCEDATASETS</span><span class="si">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;**********************************&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;**********************************&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;**** Processing dataset </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="c1"># check to make sure the latest snapshot exists on local</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>zfs<span class="w"> </span>list<span class="w"> </span>-t<span class="w"> </span>snapshot<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;@remotebackup-snapshot &quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Success] </span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot exists on local as expected&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] </span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot does not exist on local. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failure&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot does not exist on local. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="c1"># check to make sure the renamed snapshot does not exist on local</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>zfs<span class="w"> </span>list<span class="w"> </span>-t<span class="w"> </span>snapshot<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;@remotebackup-snapshot-1 &quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Success] </span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1 does not exist on local as expected&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] </span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1 already exists on local. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failure&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1 already exists on local. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="c1"># check to make sure the latest snapshot exists on remote</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>ssh<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REMOTESERVER</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;zfs list -t snapshot </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2"> | grep -q \&quot;@remotebackup-snapshot \&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Success] </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot exists on remote as expected&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot does not exist on remote. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failure&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot does not exist on remote. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="c1"># check to make sure the renamed snapshot does not exist</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>ssh<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REMOTESERVER</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;zfs list -t snapshot </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2"> | grep -q \&quot;@remotebackup-snapshot-1 \&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Success] </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1 does not exist on remote as expected&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1 already exists on remote. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failure&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1 already exists on remote. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="c1"># Rename snapshots on both local and remote</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Renaming snapshot on the local&quot;</span>
<span class="w">  </span>zfs<span class="w"> </span>rename<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] Renaming snapshot on the local failed. Skipping backup of </span><span class="nv">$SRC</span><span class="s2">&quot;</span>
<span class="w">    </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failure&quot;</span><span class="w"> </span><span class="s2">&quot;Renaming snapshot on the local failed. Skipping backup of </span><span class="nv">$SRC</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Renaming snapshot on the remote&quot;</span>
<span class="w">  </span>ssh<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REMOTESERVER</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;zfs rename </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] Renaming snapshot on the remote failed. Skipping backup of </span><span class="nv">$SRC</span><span class="s2">&quot;</span>
<span class="w">    </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failure&quot;</span><span class="w"> </span><span class="s2">&quot;Renaming snapshot on the remote failed. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="c1"># create snapshot on remote</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Creating snapshot on the remote&quot;</span>
<span class="w">  </span>ssh<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REMOTESERVER</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;zfs snapshot </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] Creating snapshot on the remote failed. Skipping backup of </span><span class="nv">$SRC</span><span class="s2">&quot;</span>
<span class="w">    </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failure&quot;</span><span class="w"> </span><span class="s2">&quot;Creating snapshot on the remote failed. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="c1"># Initiate zfs send</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Initiating zfs send for </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span>ssh<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REMOTESERVER</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;zfs send -vi </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot-1 </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">@remotebackup-snapshot&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>zfs<span class="w"> </span>receive<span class="w"> </span>-o<span class="w"> </span><span class="nv">readonly</span><span class="o">=</span>on<span class="w"> </span>-o<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>noauto<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUPBASE</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Failed] Sending snapshot failed. Skipping backup of </span><span class="nv">$SRC</span><span class="s2">&quot;</span>
<span class="w">    </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Failure&quot;</span><span class="w"> </span><span class="s2">&quot;Sending snapshot failed. Skipping backup of </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">continue</span>
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span><span class="nv">SRC_COMPLETED</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">SRC_COMPLETED</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[Success] Zfs send for </span><span class="si">${</span><span class="nv">SRC</span><span class="si">}</span><span class="s2"> completed&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;**********************************&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;**********************************&quot;</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;**********************************&quot;</span>
<span class="k">done</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SRC_COMPLETED</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span>fn_notify<span class="w"> </span><span class="s2">&quot;Zima Zfs Sync Completed&quot;</span><span class="w"> </span><span class="s2">&quot;The following datasets were successfully synced: </span><span class="si">${</span><span class="nv">SRC_COMPLETED</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">fi</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Ended sync on </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>
<p>This script is not pretty, has plenty of duplicate commands and statements. I prefer function over form. My primary goals with this script are error detection and verbosity. Because I rely on hardcoded snapshot names, and because zfs send receive needs the snapshots perfectly synced on both sides, I really want to make sure I preserve the snapshots. Otherwise, incremental sync will break and I'll need to do a full sync again. If anything goes wrong, this script will immediately halt, log the error and notify via ntfy so I can go in and fix it manually.</p>
<p>I have this script set to run weekly via the <code>zfsbackup</code> user's cron on the backup machine. I also have the root cron scripts running nightly to delete the rotated snapshots (named <code>@remotebackup-snapshot-1</code>) for each source and backup dataset on both machines.</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="May 17, 2025 18:31:40 UTC"><span class="timeago" datetime="2025-05-17T18:31:40+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="May 17, 2025 18:31:40 UTC">2025-05-17</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="May 14, 2025 18:15:40 UTC"><span class="timeago" datetime="2025-05-14T18:15:40+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="May 14, 2025 18:15:40 UTC">2025-05-14</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <!--
  Copyright (c) 2016-2022 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Footer -->
<footer class="md-footer">

  <!-- Link to previous and/or next page -->
  
    <nav
      class="md-footer__inner md-grid"
      aria-label="footer.title"
    >

      <!-- Link to previous page -->
      
        
        <a
          href="../tape_backup/"
          class="md-footer__link md-footer__link--prev"
          aria-label="Previous: Tape Backup"
          rel="prev"
        >
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Tape Backup
            </div>
          </div>
        </a>
      

      <!-- Link to next page -->
      
        
        <a
          href="../zfshost/"
          class="md-footer__link md-footer__link--next"
          aria-label="Next: Zfshost"
          rel="next"
        >
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Zfshost
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
          </div>
        </a>
      
    </nav>
  

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!-- Social links -->
      
        <div class="md-social">
  
    
    
    
    
    <a href="/feed_rss_created.xml" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64m0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0m32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.instant", "search.suggest", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "search.highlight"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
    
  </body>
</html>